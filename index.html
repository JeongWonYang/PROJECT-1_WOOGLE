<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WOOGLE — Notes Archive (with Password)</title>
  <style>
    :root{
      --bg:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb; --primary:#1a73e8;
      --chip:#f3f4f6; --card:#ffffff; --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:16px; --radius-sm:12px; --radius-xs:8px;
      --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,"Noto Sans KR","Malgun Gothic",sans-serif}
    a{color:inherit;text-decoration:none}
    button{cursor:pointer;border:0}
    .container{max-width:1100px;margin:0 auto;padding:24px}

    /* --- Home (Google-like) --- */
    .home{min-height:100vh;display:grid;place-items:center}
    .home-inner{display:flex;flex-direction:column;align-items:center;gap:24px;width:100%}
    .logo{font-size:72px;font-weight:700;letter-spacing:-1px}
    .logo span:nth-child(1){color:#4285F4}
    .logo span:nth-child(2){color:#EA4335}
    .logo span:nth-child(3){color:#FBBC05}
    .logo span:nth-child(4){color:#4285F4}
    .logo span:nth-child(5){color:#34A853}
    .logo span:nth-child(6){color:#EA4335}

    .searchbar{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:999px;padding:10px 16px;width:min(720px,92%);background:#fff;box-shadow:var(--shadow)}
    .searchbar input{flex:1;border:0;outline:0;font-size:18px;padding:6px 4px}
    .search-actions{display:flex;gap:10px}
    .btn{border-radius:999px;background:#f8f9fa;padding:10px 16px;color:#202124;font-weight:500}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{background:transparent;border:1px solid var(--border)}

    .cat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;width:min(720px,92%)}
    .cat{border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;background:#fff;display:flex;align-items:center;gap:10px;box-shadow:var(--shadow)}
    .dot{width:12px;height:12px;border-radius:50%}
    .cat b{font-weight:600}

    /* --- App Shell --- */
    header.app{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--border)}
    header .bar{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 24px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .mini{font-size:24px}
    .brand .mini span{display:inline-block}
    .brand .mini span:nth-child(1){color:#4285F4}
    .brand .mini span:nth-child(2){color:#EA4335}
    .brand .mini span:nth-child(3){color:#FBBC05}
    .brand .mini span:nth-child(4){color:#4285F4}
    .brand .mini span:nth-child(5){color:#34A853}
    .brand .mini span:nth-child(6){color:#EA4335}

    .app-search{flex:1;display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:999px;padding:8px 14px;max-width:560px}
    .app-search input{flex:1;border:0;outline:0;font-size:16px}

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px;color:var(--muted)}

    .toolbar{display:flex;gap:10px;align-items:center}
    .auth-badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .auth-badge.ok{color:var(--ok);border-color:var(--ok)}
    .auth-badge.warn{color:var(--warn);border-color:var(--warn)}

    main{padding:18px 24px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 4;border:1px solid var(--border);border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:10px}
    @media(max-width:1024px){.card{grid-column:span 6}}
    @media(max-width:640px){.card{grid-column:span 12}}
    .title{font-weight:700;font-size:17px}
    .meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .pill{font-size:12px;border-radius:999px;border:1px solid var(--border);padding:4px 8px}
    .content{color:#374151;white-space:pre-line}
    .actions{display:flex;gap:8px;margin-top:auto}
    .btn.outline{background:#fff;border:1px solid var(--border)}

    /* --- Modal --- */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.show{display:flex}
    .sheet{width:min(820px,100%);background:#fff;border-radius:20px;box-shadow:var(--shadow);border:1px solid var(--border)}
    .sheet header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .sheet main{padding:20px;display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media(max-width:800px){.sheet main{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .field input[type="text"], .field input[type="password"], .field textarea, .field select{border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}
    .field textarea{min-height:160px;resize:vertical}
    .thumb{width:100%;border:1px dashed var(--border);border-radius:12px;min-height:160px;display:grid;place-items:center;overflow:hidden}
    .thumb img{max-width:100%;max-height:260px;display:block}
    .sheet footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}

    /* --- Simple Sheet (Auth) --- */
    .sheet.simple main{display:block}

    /* --- Empty --- */
    .empty{border:1px dashed var(--border);border-radius:16px;padding:24px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <!-- Home -->
  <section id="home" class="home">
    <div class="home-inner">
      <div class="logo" aria-label="WOOGLE">
        <span>W</span><span>O</span><span>O</span><span>G</span><span>L</span><span>E</span>
      </div>
      <div class="searchbar">
        <input id="homeQuery" type="search" placeholder="검색어 또는 태그를 입력하세요 (예: 연차, 전자 문서, 결재)" />
        <div class="search-actions">
          <button class="btn" id="goSearch">WOOGLE 검색</button>
          <button class="btn primary" id="goNew">+ 새 글</button>
        </div>
      </div>
      <div class="cat-grid" id="homeCats"></div>
    </div>
  </section>

  <!-- App -->
  <header class="app" id="appHeader" style="display:none">
    <div class="bar container">
      <a href="#/" class="brand" id="brandLink" title="WOOGLE Home">
        <div class="mini" aria-label="WOOGLE"><span>W</span><span>O</span><span>O</span><span>G</span><span>L</span><span>E</span></div>
      </a>
      <div class="app-search">
        <input id="appQuery" type="search" placeholder="검색 (제목, 내용, 태그) — Enter로 검색" />
        <button class="btn" id="appSearchBtn">검색</button>
      </div>
      <div class="toolbar">
        <span id="authBadge" class="auth-badge">🔒 잠금됨</span>
        <button class="btn ghost" id="loginBtn">로그인</button>
        <button class="btn ghost" id="changePwBtn" style="display:none">비밀번호 설정/변경</button>
        <button class="btn ghost" id="logoutBtn" style="display:none">로그아웃</button>
        <button class="btn primary" id="newNoteBtn">+ 새 글</button>
        <button class="btn outline" id="importBtn" title="JSON 가져오기">가져오기</button>
        <button class="btn outline" id="exportBtn" title="JSON 내보내기">내보내기</button>
        <input type="file" id="importFile" accept="application/json" hidden />
      </div>
    </div>
  </header>

  <main class="container" id="appMain" style="display:none">
    <div class="chips" id="filterChips"></div>
    <div class="grid" id="noteGrid"></div>
    <div class="empty" id="emptyState" style="display:none">검색 결과가 없습니다. 다른 키워드나 카테고리를 시도해 보세요.</div>
  </main>

  <!-- Editor Modal -->
  <div class="modal" id="editorModal" role="dialog" aria-modal="true">
    <div class="sheet" role="document">
      <header>
        <strong id="modalTitle">새 글</strong>
        <button class="btn outline" id="closeEditor">닫기</button>
      </header>
      <main>
        <div>
          <div class="field">
            <label for="fTitle">제목</label>
            <input id="fTitle" type="text" placeholder="예: 연차 신청" />
          </div>
          <div class="field">
            <label for="fContent">내용</label>
            <textarea id="fContent" placeholder="업무 절차, 체크리스트, 링크 등"></textarea>
          </div>
        </div>
        <aside>
          <div class="field">
            <label for="fCategory">카테고리</label>
            <select id="fCategory"></select>
          </div>
          <div class="field">
            <label for="fPriority">우선순위</label>
            <select id="fPriority">
              <option value="low">낮음</option>
              <option value="medium">보통</option>
              <option value="high">높음</option>
            </select>
          </div>
          <div class="field">
            <label for="fTags">태그 (쉼표로 구분)</label>
            <input id="fTags" type="text" placeholder="예: 전자 문서, 결재" />
          </div>
          <div class="field">
            <label for="fImage">이미지</label>
            <div class="thumb" id="thumb"><span>이미지 미리보기</span></div>
            <input id="fImage" type="file" accept="image/*" />
          </div>
        </aside>
      </main>
      <footer>
        <button class="btn outline" id="deleteBtn" style="display:none">삭제</button>
        <button class="btn primary" id="saveBtn">저장</button>
      </footer>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modal" id="authModal" role="dialog" aria-modal="true">
    <div class="sheet simple" role="document">
      <header>
        <strong>로그인</strong>
        <button class="btn outline" id="closeAuth">닫기</button>
      </header>
      <main style="padding:20px">
        <div id="authInfo" style="margin-bottom:8px;color:var(--muted)">수정을 하려면 비밀번호가 필요합니다.</div>
        <div class="field">
          <label for="authPw">비밀번호</label>
          <input id="authPw" type="password" placeholder="비밀번호 입력" />
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button class="btn ghost" id="gotoChange">비밀번호 설정/변경</button>
          <button class="btn primary" id="doLogin">로그인</button>
        </div>
      </main>
    </div>
  </div>

  <!-- Password Set/Change Modal -->
  <div class="modal" id="pwModal" role="dialog" aria-modal="true">
    <div class="sheet simple" role="document">
      <header>
        <strong id="pwTitle">비밀번호 설정</strong>
        <button class="btn outline" id="closePw">닫기</button>
      </header>
      <main style="padding:20px">
        <div id="pwInfo" style="margin-bottom:8px;color:var(--muted)"></div>
        <div class="field" id="rowCurrent" style="display:none">
          <label for="pwCurrent">현재 비밀번호</label>
          <input id="pwCurrent" type="password" placeholder="현재 비밀번호" />
        </div>
        <div class="field">
          <label for="pwNew">새 비밀번호</label>
          <input id="pwNew" type="password" placeholder="최소 4자" />
        </div>
        <div class="field">
          <label for="pwConfirm">새 비밀번호 확인</label>
          <input id="pwConfirm" type="password" placeholder="다시 입력" />
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button class="btn primary" id="savePwBtn">저장</button>
        </div>
      </main>
    </div>
  </div>

<script>
/**
 * WOOGLE Notes Archive — with Password Lock
 * - Password hash saved in localStorage (salted SHA-256)
 * - Session (20분) in sessionStorage
 * - 로그인/로그아웃/비밀번호 설정·변경
 * - 편집/저장/삭제 시 인증 요구
 */

const STORAGE_KEY = 'woogle.store.v1';
const AUTH_KEY = 'woogle.auth.v1';
const SESSION_KEY = 'woogle.session.v1';
const SESSION_MINUTES = 20;

const seed = {
  notes: [],
  categories: [
    { id:"업무 전반", name:"업무 전반", color:"#3498db" },
    { id:"디자인", name:"디자인", color:"#e74c3c" },
    { id:"자료 관리·리서치", name:"자료 관리·리서치", color:"#f39c12" },
    { id:"문서", name:"문서", color:"#9b59b6" },
    { id:"행정·운영", name:"행정·운영", color:"#1abc9c" },
    { id:"기획·제안", name:"기획·제안", color:"#34495e" },
    { id:"learning", name:"Learning", color:"#16a085" },
    { id:"archive", name:"Archive", color:"#95a5a6" }
  ],
  exportDate: new Date().toISOString(),
  version: '1.0'
};

// --- Store helpers ---
const store = {
  get(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ localStorage.setItem(STORAGE_KEY, JSON.stringify(seed)); return JSON.parse(JSON.stringify(seed)); }
    try{ return JSON.parse(raw); } catch(e){ console.warn('Resetting store due to parse error'); localStorage.setItem(STORAGE_KEY, JSON.stringify(seed)); return JSON.parse(JSON.stringify(seed)); }
  },
  set(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
};

// --- Auth helpers ---
function getAuth(){
  const raw = localStorage.getItem(AUTH_KEY);
  if(!raw) return null;
  try{ return JSON.parse(raw); } catch{ return null; }
}
function setAuth(obj){ localStorage.setItem(AUTH_KEY, JSON.stringify(obj)); }
function isPasswordSet(){ return !!(getAuth()?.hash); }

function getSession(){
  try{ return JSON.parse(sessionStorage.getItem(SESSION_KEY)||'null'); }catch{ return null; }
}
function setSessionAuthed(minutes=SESSION_MINUTES){
  const until = Date.now() + minutes*60*1000;
  sessionStorage.setItem(SESSION_KEY, JSON.stringify({until}));
  updateAuthUI();
}
function clearSession(){ sessionStorage.removeItem(SESSION_KEY); updateAuthUI(); }
function isAuthed(){ const s = getSession(); return !!(s && s.until> Date.now()); }

function toHex(buffer){ return Array.from(new Uint8Array(buffer)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function sha256Hex(str){ const buf = new TextEncoder().encode(str); const hash = await crypto.subtle.digest('SHA-256', buf); return toHex(hash); }
function randomHex(len=16){ const a = new Uint8Array(len); crypto.getRandomValues(a); return Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function hashWithSalt(pw, salt){ return sha256Hex(`${salt}|${pw}`); }

async function verifyPassword(pw){
  const rec = getAuth();
  if(!rec) return false;
  const h = await hashWithSalt(pw, rec.salt);
  return h === rec.hash;
}

async function setOrChangePassword({current, next}){
  if((next||'').length < 4) throw new Error('비밀번호는 최소 4자');
  const existed = isPasswordSet();
  if(existed){
    const ok = await verifyPassword(current||'');
    if(!ok) throw new Error('현재 비밀번호가 일치하지 않습니다');
  }
  const salt = randomHex(16);
  const hash = await hashWithSalt(next, salt);
  setAuth({salt, hash});
  setSessionAuthed();
}

function updateAuthUI(){
  const badge = document.getElementById('authBadge');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const changeBtn = document.getElementById('changePwBtn');
  const authed = isAuthed();
  const hasPw = isPasswordSet();
  if(authed){
    badge.textContent = '🔓 로그인됨';
    badge.className = 'auth-badge ok';
    loginBtn.style.display='none';
    logoutBtn.style.display='inline-flex';
    changeBtn.style.display='inline-flex';
  } else {
    badge.textContent = hasPw? '🔒 잠금됨' : '⚠️ 비밀번호 미설정';
    badge.className = 'auth-badge ' + (hasPw? '':'warn');
    loginBtn.style.display='inline-flex';
    logoutBtn.style.display='none';
    changeBtn.style.display='inline-flex';
  }
}

// --- Simple Router ---
window.addEventListener('hashchange', renderByRoute);
function renderByRoute(){
  const hash = location.hash || '#/';
  const params = new URLSearchParams(hash.split('?')[1] || '');
  const q = params.get('q')?.trim() || '';
  const cat = params.get('cat') || '';
  if(hash.startsWith('#/search') || hash.startsWith('#/app')){
    showApp(q, cat);
  } else {
    showHome();
  }
}

// --- Home rendering ---
function showHome(){
  document.getElementById('home').style.display='grid';
  document.getElementById('appHeader').style.display='none';
  document.getElementById('appMain').style.display='none';
  const {categories} = store.get();
  const grid = document.getElementById('homeCats');
  grid.innerHTML = '';
  categories.forEach(c=>{
    const el = document.createElement('button');
    el.className='cat';
    el.innerHTML = `<span class="dot" style="background:${c.color}"></span><b>${c.name}</b>`;
    el.onclick = ()=>{ location.hash = `#/search?cat=${encodeURIComponent(c.id)}`; };
    grid.appendChild(el);
  });
}

// --- App rendering ---
function showApp(q='', cat=''){
  document.getElementById('home').style.display='none';
  document.getElementById('appHeader').style.display='block';
  document.getElementById('appMain').style.display='block';
  updateAuthUI();

  const state = store.get();
  const chips = document.getElementById('filterChips');
  chips.innerHTML = '';
  state.categories.forEach(c=>{
    const chip = document.createElement('button');
    chip.className = 'chip';
    chip.style.borderColor = c.color;
    chip.style.color = c.color;
    chip.textContent = c.name;
    chip.onclick = ()=>{ location.hash = `#/search?cat=${encodeURIComponent(c.id)}${q?`&q=${encodeURIComponent(q)}`:''}` };
    chips.appendChild(chip);
  });

  const input = document.getElementById('appQuery');
  input.value = q;

  const grid = document.getElementById('noteGrid');
  grid.innerHTML = '';
  const results = searchNotes(state, q, cat);
  document.getElementById('emptyState').style.display = results.length? 'none':'block';

  results.forEach(n=>{
    const card = document.createElement('article');
    card.className='card';
    const catObj = n.categoryId ? state.categories.find(c=>c.id===n.categoryId) : null;
    const img = (n.images && n.images[0]) ? `<img alt="image" src="${n.images[0].data}" style="width:100%;border-radius:12px;max-height:200px;object-fit:cover">` : '';
    card.innerHTML = `
      <div class="title">${escapeHtml(n.title)}</div>
      <div class="meta">
        ${catObj?`<span class="pill" style="border-color:${catObj.color};color:${catObj.color}">${catObj.name}</span>`:''}
        <span class="pill">prio: ${n.priority}</span>
        ${(n.tags||[]).map(t=>`<span class="pill">#${escapeHtml(t)}</span>`).join('')}
      </div>
      ${img}
      <div class="content">${highlight(escapeHtml(n.content), q)}</div>
      <div class="actions">
        <button class="btn outline" data-id="${n.id}" data-action="edit">수정</button>
      </div>
    `;
    card.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-action="edit"]');
      if(btn){
        guardAuth(()=> openEditor(n.id));
      }
    });
    grid.appendChild(card);
  });
}

function searchNotes(state, q, cat){
  const qn = (q||'').toLowerCase();
  const byCat = (cat) ? (x=> (x.categoryId===cat)) : (_=>true);
  const hit = (txt)=> txt && txt.toLowerCase().includes(qn);
  return state.notes.filter(n=>{
    const inTitle = hit(n.title||'');
    const inContent = hit(n.content||'');
    const inTags = (n.tags||[]).some(t=> hit(t));
    const okQ = qn? (inTitle||inContent||inTags) : true;
    return okQ && byCat(n);
  }).sort((a,b)=> new Date(b.updatedAt||b.createdAt) - new Date(a.updatedAt||a.createdAt));
}

// --- Editor ---
let editingId = null;
function openEditor(id){
  const state = store.get();
  const isEdit = !!id;
  editingId = id || null;
  document.getElementById('modalTitle').textContent = isEdit? '글 수정':'새 글';
  document.getElementById('deleteBtn').style.display = isEdit? 'inline-flex':'none';

  const sel = document.getElementById('fCategory');
  sel.innerHTML = '<option value="">(카테고리 없음)</option>' + state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');

  const fTitle = document.getElementById('fTitle');
  const fContent = document.getElementById('fContent');
  const fPriority = document.getElementById('fPriority');
  const fTags = document.getElementById('fTags');
  const thumb = document.getElementById('thumb');

  let note = { title:'', content:'', categoryId:'', priority:'medium', tags:[], images:[] };
  if(isEdit){ note = state.notes.find(n=>n.id===id) || note; }
  fTitle.value = note.title||'';
  fContent.value = note.content||'';
  sel.value = note.categoryId||'';
  fPriority.value = note.priority||'medium';
  fTags.value = (note.tags||[]).join(', ');
  thumb.innerHTML = (note.images&&note.images[0]) ? `<img src="${note.images[0].data}" alt="preview">` : '<span>이미지 미리보기</span>';

  document.getElementById('editorModal').classList.add('show');
}

function closeEditor(){ document.getElementById('editorModal').classList.remove('show'); }

// Save (guarded)
function saveEditor(){ guardAuth(_saveEditorBody); }

function _saveEditorBody(){
  const state = store.get();
  const fTitle = document.getElementById('fTitle').value.trim();
  const fContent = document.getElementById('fContent').value.trim();
  const fCategory = document.getElementById('fCategory').value || null;
  const fPriority = document.getElementById('fPriority').value;
  const fTags = document.getElementById('fTags').value.split(',').map(s=>s.trim()).filter(Boolean);
  const thumbImg = document.querySelector('#thumb img');
  const images = thumbImg ? [{ id: Date.now()+Math.random(), name:'image', data: thumbImg.src, size: 0 }] : [];

  if(!fTitle){ alert('제목을 입력하세요.'); return; }

  if(editingId){
    const idx = state.notes.findIndex(n=>n.id===editingId);
    if(idx>-1){
      state.notes[idx] = { ...state.notes[idx], title:fTitle, content:fContent, categoryId:fCategory, priority:fPriority, tags:fTags, images, updatedAt:new Date().toISOString() };
    }
  } else {
    state.notes.unshift({ id: Date.now(), title:fTitle, content:fContent, categoryId:fCategory, priority:fPriority, tags:fTags, images, createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() });
  }
  store.set(state);
  closeEditor();
  location.hash = '#/app';
  renderByRoute();
}

function deleteNote(){ guardAuth(_deleteNoteBody); }
function _deleteNoteBody(){
  if(!editingId) return;
  if(!confirm('이 글을 삭제할까요?')) return;
  const state = store.get();
  state.notes = state.notes.filter(n=> n.id!==editingId);
  store.set(state);
  closeEditor();
  renderByRoute();
}

// Image input
const fImage = document.getElementById('fImage');
if(fImage){
  fImage.addEventListener('change', (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      const thumb = document.getElementById('thumb');
      thumb.innerHTML = `<img src="${reader.result}" alt="preview">`;
    };
    reader.readAsDataURL(file);
  });
}

// --- Utilities ---
function escapeHtml(str=''){ return str.replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
function highlight(text, q){
  if(!q) return text;
  try{ const re = new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'); return text.replace(re,'<mark>$1</mark>'); }catch(e){ return text; }
}

// --- Import/Export ---
function exportJson(){
  const data = store.get();
  const blob = new Blob([JSON.stringify({...data, exportDate:new Date().toISOString()}, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `woogle-export-${new Date().toISOString().slice(0,10)}.json`;
  a.click(); URL.revokeObjectURL(url);
}
function importJsonFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if(!obj.notes || !obj.categories) throw new Error('형식이 올바르지 않습니다');
      store.set(obj);
      alert('가져오기가 완료되었습니다.');
      renderByRoute();
    }catch(e){ alert('가져오기 실패: '+e.message); }
  };
  reader.readAsText(file);
}

// --- Auth Flow & Guards ---
let afterLogin = null; // pending action
function guardAuth(fn){
  if(isAuthed()) { fn(); return; }
  // if no password set, guide to set first
  if(!isPasswordSet()){
    openPwModal();
  } else {
    openAuthModal();
  }
  afterLogin = fn;
}

function openAuthModal(){
  document.getElementById('authInfo').textContent = '수정을 하려면 비밀번호가 필요합니다.';
  document.getElementById('authPw').value='';
  document.getElementById('authModal').classList.add('show');
}
function closeAuthModal(){ document.getElementById('authModal').classList.remove('show'); }

function openPwModal(){
  const has = isPasswordSet();
  document.getElementById('pwTitle').textContent = has? '비밀번호 변경' : '비밀번호 설정';
  document.getElementById('pwInfo').textContent = has? '현재 비밀번호 확인 후 새 비밀번호를 설정하세요.' : '처음 사용하는 경우 비밀번호를 설정하세요.';
  document.getElementById('rowCurrent').style.display = has? 'block':'none';
  document.getElementById('pwCurrent').value='';
  document.getElementById('pwNew').value='';
  document.getElementById('pwConfirm').value='';
  document.getElementById('pwModal').classList.add('show');
}
function closePwModal(){ document.getElementById('pwModal').classList.remove('show'); }

// --- Wire events ---
// Home
document.getElementById('goSearch').addEventListener('click', ()=>{
  const q = document.getElementById('homeQuery').value.trim();
  location.hash = q? `#/search?q=${encodeURIComponent(q)}` : '#/app';
});

document.getElementById('homeQuery').addEventListener('keydown', (e)=>{ if(e.key==='Enter') document.getElementById('goSearch').click(); });

document.getElementById('goNew').addEventListener('click', ()=>{ guardAuth(()=> openEditor()); });

// App bar
document.getElementById('appSearchBtn').addEventListener('click', ()=>{
  const q = document.getElementById('appQuery').value.trim();
  const base = '#/search';
  const cat = new URLSearchParams(location.hash.split('?')[1] || '').get('cat');
  location.hash = `${base}?${cat?`cat=${encodeURIComponent(cat)}&`:''}${q?`q=${encodeURIComponent(q)}`:''}`;
});

document.getElementById('appQuery').addEventListener('keydown', (e)=>{ if(e.key==='Enter') document.getElementById('appSearchBtn').click(); });

// Editor buttons
document.getElementById('closeEditor').addEventListener('click', closeEditor);
document.getElementById('saveBtn').addEventListener('click', saveEditor);
document.getElementById('deleteBtn').addEventListener('click', ()=> deleteNote());

// Import/Export
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', (e)=>{ const f = e.target.files?.[0]; if(f) importJsonFile(f); e.target.value=''; });

document.getElementById('exportBtn').addEventListener('click', exportJson);

// Brand click returns home
(document.getElementById('brandLink')).addEventListener('click', (e)=>{ e.preventDefault(); location.hash = '#/'; });

// Auth toolbar
(document.getElementById('loginBtn')).addEventListener('click', ()=>{ isPasswordSet()? openAuthModal(): openPwModal(); });
(document.getElementById('logoutBtn')).addEventListener('click', ()=>{ clearSession(); alert('로그아웃 되었습니다.'); });
(document.getElementById('changePwBtn')).addEventListener('click', ()=> openPwModal());

// Auth modal actions
(document.getElementById('closeAuth')).addEventListener('click', ()=>{ closeAuthModal(); afterLogin=null; });
(document.getElementById('gotoChange')).addEventListener('click', ()=>{ closeAuthModal(); openPwModal(); });
(document.getElementById('doLogin')).addEventListener('click', async ()=>{
  const pw = document.getElementById('authPw').value;
  if(!pw){ alert('비밀번호를 입력하세요'); return; }
  if(await verifyPassword(pw)){
    setSessionAuthed();
    closeAuthModal();
    if(typeof afterLogin==='function'){ const fn = afterLogin; afterLogin=null; fn(); }
  } else {
    alert('비밀번호가 올바르지 않습니다');
  }
});

// Password modal actions
(document.getElementById('closePw')).addEventListener('click', ()=>{ closePwModal(); });
(document.getElementById('savePwBtn')).addEventListener('click', async ()=>{
  const has = isPasswordSet();
  const current = document.getElementById('pwCurrent').value;
  const next = document.getElementById('pwNew').value;
  const confirm = document.getElementById('pwConfirm').value;
  if(next!==confirm){ alert('새 비밀번호와 확인이 일치하지 않습니다'); return; }
  try{
    await setOrChangePassword({current: has? current: undefined, next});
    closePwModal();
    alert('비밀번호가 저장되었습니다. (20분 동안 로그인 상태 유지)');
    if(typeof afterLogin==='function'){ const fn = afterLogin; afterLogin=null; fn(); }
  }catch(e){ alert(e.message||'실패했습니다'); }
});

// Init
updateAuthUI();
renderByRoute();
</script>
</body>
</html>
